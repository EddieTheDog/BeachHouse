<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beach House Admin Dashboard v2.7</title>
<style>
html,body{height:100%;margin:0;padding:0;font-family:Arial,sans-serif;background:#222;color:#fff;display:flex;justify-content:center;align-items:flex-start;}
.container{width:95%;max-width:1000px;padding:20px;}
button,input,textarea{padding:8px;margin:5px;border-radius:10px;border:none;}
button{cursor:pointer;font-weight:bold;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:10px;border:1px solid #444;text-align:center;}
h2,h3{margin-top:20px;}
</style>
</head>
<body>
<div class="container">
<h1>Beach House Admin Dashboard v2.7</h1>

<h2>Schedule Guest</h2>
<input type="text" id="guestLastName" placeholder="Guest Last Name">
<input type="date" id="startDate">
<input type="date" id="endDate">
<button id="addGuestBtn">Add Guest</button>
<p id="guestStatus"></p>

<h2>Current Guests</h2>
<table id="guestsTable">
<tr>
<th>Last Name</th><th>Start</th><th>End</th><th>Days Left</th><th>Actions</th>
</tr>
</table>

<h2>Work Requests</h2>
<ul id="workRequestsList"></ul>

<h2>Guest Messages</h2>
<ul id="messagesList"></ul>

<h2>Controls</h2>
<button id="forceVerificationBtn">Force Verification Modal</button>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://ofnlpqfscyecatetnuqi.supabase.co';
const SUPABASE_KEY = 'sb_publishable_jjdmHkgGrbjqYwY14kS9ng_Ivuq-Pjc';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const guestTable = document.getElementById('guestsTable');
const workRequestsList = document.getElementById('workRequestsList');
const messagesList = document.getElementById('messagesList');

async function loadGuests(){
  const { data } = await supabase.from('guests').select('*').order('start_date',{ascending:true});
  guestTable.innerHTML=`<tr><th>Last Name</th><th>Start</th><th>End</th><th>Days Left</th><th>Actions</th></tr>`;
  const today = new Date();
  data.forEach(g=>{
    const start = new Date(g.start_date); const end = new Date(g.end_date);
    const daysLeft = Math.max(0,Math.ceil((end-today)/(1000*60*60*24))+1);
    const row = document.createElement('tr');
    row.innerHTML=`
      <td>${g.guest_last_name}</td>
      <td>${g.start_date}</td>
      <td>${g.end_date}</td>
      <td>${daysLeft}</td>
      <td>
        <button onclick="extendGuest(${g.id})">Extend</button>
        <button onclick="shortenGuest(${g.id})">Shorten</button>
        <button onclick="cancelGuest(${g.id})">Cancel</button>
        <button onclick="unlockGuest(${g.id})">Unlock</button>
      </td>`;
    guestTable.appendChild(row);
  });
}
loadGuests();

// Add guest
document.getElementById('addGuestBtn').onclick = async ()=>{
  const lastName = document.getElementById('guestLastName').value.trim();
  const start = document.getElementById('startDate').value;
  const end = document.getElementById('endDate').value;
  if(!lastName||!start||!end){document.getElementById('guestStatus').innerText="Please fill all fields"; return;}
  const { data,error } = await supabase.from('guests').insert([{guest_last_name:lastName,start_date:start,end_date:end,active:true}]);
  if(error){console.error(error);document.getElementById('guestStatus').innerText="Error adding guest"; return;}
  document.getElementById('guestStatus').innerText="Guest added!";
  loadGuests();
}

// Extend guest
window.extendGuest = async (id)=>{
  const days = parseInt(prompt("Enter number of days to extend:"));
  if(isNaN(days)||days<=0) return;
  const { data:guest } = await supabase.from('guests').select('*').eq('id',id).single();
  const newEnd = new Date(guest.end_date); newEnd.setDate(newEnd.getDate()+days);
  await supabase.from('guests').update({end_date:newEnd.toISOString().slice(0,10)}).eq('id',id);
  loadGuests();
}

// Shorten guest
window.shortenGuest = async (id)=>{
  const days = parseInt(prompt("Enter number of days to shorten:"));
  if(isNaN(days)||days<=0) return;
  const { data:guest } = await supabase.from('guests').select('*').eq('id',id).single();
  const newEnd = new Date(guest.end_date); newEnd.setDate(newEnd.getDate()-days);
  await supabase.from('guests').update({end_date:newEnd.toISOString().slice(0,10)}).eq('id',id);
  loadGuests();
}

// Cancel guest
window.cancelGuest = async (id)=>{
  if(!confirm("Cancel guest? This will delete all their messages and work requests.")) return;
  await supabase.from('guests').delete().eq('id',id);
  await supabase.from('work_requests').delete().eq('guest_id',id);
  await supabase.from('messages').delete().eq('guest_id',id);
  loadGuests(); loadMessages(); loadWorkRequests();
}

// Unlock guest (force verification)
window.unlockGuest = async (id)=>{
  await supabase.from('guests').update({verification_status:'pending',verification_date:null}).eq('id',id);
  alert("Guest will be prompted to verify on their tablet.");
}

// Force all verification modals
document.getElementById('forceVerificationBtn').onclick = async ()=>{
  const { data } = await supabase.from('guests').select('*').eq('active',true);
  for(const g of data){
    await supabase.from('guests').update({verification_status:'pending',verification_date:null}).eq('id',g.id);
  }
  alert("All active guests will be prompted to verify on their tablets.");
}

// Load work requests
async function loadWorkRequests(){
  const { data } = await supabase.from('work_requests').select('*,guest_id(guest_last_name)').order('date',{ascending:true});
  workRequestsList.innerHTML='';
  data.forEach(r=>{
    const li = document.createElement('li');
    li.textContent=`${r.guest_id.guest_last_name}: ${r.request_text} (${new Date(r.date).toLocaleString()})`;
    workRequestsList.appendChild(li);
  });
}
loadWorkRequests();

// Load messages
async function loadMessages(){
  const { data } = await supabase.from('messages').select('*,guest_id(guest_last_name)').order('date',{ascending:true});
  messagesList.innerHTML='';
  data.forEach(m=>{
    const li = document.createElement('li');
    li.textContent=`${m.guest_id.guest_last_name}: ${m.message_text} (${new Date(m.date).toLocaleString()})`;
    const replyBtn = document.createElement('button'); replyBtn.textContent='Reply';
    replyBtn.onclick = async ()=>{
      const reply = prompt("Enter message for guest:");
      if(reply) await supabase.from('messages').insert([{guest_id:m.guest_id.id,message_text:reply,date:new Date().toISOString()}]);
      loadMessages();
    }
    li.appendChild(replyBtn);
    messagesList.appendChild(li);
  });
}

// Automatic cleanup
setInterval(async ()=>{
  const today = new Date().toISOString().slice(0,10);
  // Checkout finished guests
  const { data } = await supabase.from('guests').select('*').eq('active',true);
  for(const g of data){
    if(today>g.end_date){
      await supabase.from('guests').update({active:false}).eq('id',g.id);
      await supabase.from('work_requests').delete().eq('guest_id',g.id);
      await supabase.from('messages').delete().eq('guest_id',g.id);
    }
  }
  loadGuests(); loadMessages(); loadWorkRequests();
},60000);

</script>
</body>
</html>
