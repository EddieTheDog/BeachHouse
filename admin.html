<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><title>Admin Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 p-8 font-sans">
    <div class="max-w-2xl mx-auto space-y-6">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-200">
            <h1 class="text-3xl font-black mb-8 uppercase tracking-tighter">Register New Guest</h1>
            <div class="space-y-4">
                <input type="text" id="ln" placeholder="Guest Last Name" class="w-full border p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex gap-4">
                    <input type="date" id="ci" class="flex-1 border p-4 rounded-2xl">
                    <input type="date" id="co" class="flex-1 border p-4 rounded-2xl">
                </div>
                <button id="add" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-lg hover:bg-blue-700 shadow-lg shadow-blue-200 transition">GENERATE STAY & PIN</button>
            </div>
        </div>

        <div id="list" class="space-y-3"></div>
    </div>

<script>
const SUPABASE_URL = 'https://ofnlpqfscyecatetnuqi.supabase.co';
const SUPABASE_KEY = 'sb_publishable_jjdmHkgGrbjqYwY14kS9ng_Ivuq-Pjc';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

document.getElementById('add').onclick = async () => {
    const last = document.getElementById('ln').value;
    const inD = document.getElementById('ci').value;
    const outD = document.getElementById('co').value;
    // Generate a clean 6-digit PIN
    const pin = Math.floor(100000 + Math.random() * 900000).toString();

    if(!last || !inD || !outD) return alert("Please fill in all guest details.");

    const { error } = await supabaseClient.from('families').insert({
        last_name: last, 
        check_in_date: inD, 
        check_out_date: outD, 
        access_code: pin
    });

    if(!error) {
        alert(`Success! The ${last} family code is: ${pin}`);
        document.getElementById('ln').value = '';
        loadGuests();
    } else { alert("Error: " + error.message); }
};

async function loadGuests() {
    const { data } = await supabaseClient.from('families').select('*').order('created_at', {ascending:false});
    const container = document.getElementById('list');
    container.innerHTML = data?.map(f => `
        <div class="p-6 bg-white rounded-2xl border border-slate-200 flex justify-between items-center shadow-sm">
            <div>
                <p class="font-black text-xl uppercase tracking-tighter">${f.last_name} FAMILY</p>
                <p class="text-blue-600 font-mono font-black text-lg">PIN: ${f.access_code}</p>
            </div>
            <div class="flex flex-col items-end">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${f.check_in_date} TO ${f.check_out_date}</p>
                <button onclick="del('${f.id}')" class="text-red-500 font-bold text-xs mt-2 hover:underline">Delete Stay</button>
            </div>
        </div>
    `).join('') || '';
}

window.del = async (id) => {
    if(confirm("Permanently delete this guest stay?")) {
        await supabaseClient.from('families').delete().eq('id', id);
        loadGuests();
    }
};

loadGuests();
</script>
</body>
</html>
