<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beach House Guest</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  .calendar { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; }
  .day { width: 32px; height: 32px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; }
  .past { background-color:#e5e7eb; color:#9ca3af; }
  .current { background-color:#22c55e; color:white; font-weight:bold; }
  .future { background-color:#f3f4f6; color:#111827; }
  .locked-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; color:white; font-size:2rem; z-index:50; display:none; }
</style>
</head>
<body class="bg-gray-50 font-sans relative">

<div class="locked-overlay" id="locked-overlay">ðŸ”’ Device Locked</div>

<div class="max-w-3xl mx-auto p-4 md:p-8">
  <header class="flex justify-between items-center mb-8">
    <h1 class="text-2xl font-bold text-gray-900">Beach House</h1>
    <p id="current-time" class="text-lg font-mono font-bold text-gray-700"></p>
  </header>

  <main class="bg-white p-6 rounded-2xl shadow-sm">
    <h2 class="text-xl font-bold mb-2" id="welcome-text">Loading...</h2>
    <p id="days-left" class="text-sm text-gray-500 mb-4"></p>

    <div id="calendar" class="calendar"></div>

    <section class="mt-6">
      <h3 class="font-bold mb-2">Message Host</h3>
      <div class="flex gap-2">
        <input type="text" id="guest-msg" class="border-2 border-gray-200 rounded-xl p-3 flex-1" placeholder="Type a message..." disabled>
        <button id="send-guest-msg" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-blue-700" disabled>Send</button>
      </div>
    </section>

    <section class="mt-6">
      <h3 class="font-bold mb-2">Messages</h3>
      <div id="message-list" class="max-h-64 overflow-y-auto space-y-2"></div>
    </section>
  </main>
</div>

<script>
const SUPABASE_URL = 'https://ofnlpqfscyecatetnuqi.supabase.co';
const SUPABASE_KEY = 'sb_publishable_jjdmHkgGrbjqYwY14kS9ng_Ivuq-Pjc';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentGuest = null;
let guestLock = false;

// --- CLOCK ---
function updateTime() {
    const now = new Date();
    document.getElementById('current-time').innerText = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}
setInterval(updateTime, 1000);

// --- SAFE AUTOMATIC LOGIN ---
async function guestLogin() {
    const todayISO = new Date().toISOString().split('T')[0];

    // Check if guest is remembered
    let lastName = localStorage.getItem('guest_last_name');

    let guest;
    if(lastName){
        const { data } = await supabaseClient.from('families')
            .select('*')
            .eq('last_name', lastName)
            .gte('check_out_date', todayISO)
            .maybeSingle();
        guest = data;
    }

    // If no stored guest or no match, ask for last name
    if(!guest){
        lastName = prompt("Enter your last name:");
        if(!lastName) return guestLogin(); // require a name
        const confirmName = confirm(`Welcome ${lastName}s! Is this correct?`);
        if(!confirmName) return guestLogin();

        const { data } = await supabaseClient.from('families')
            .select('*')
            .eq('last_name', lastName)
            .gte('check_out_date', todayISO)
            .maybeSingle();
        if(!data){
            document.getElementById('welcome-text').innerText = "No guests currently staying";
            return;
        }
        guest = data;
        localStorage.setItem('guest_last_name', lastName); // REMEMBER FOR FUTURE
    }

    currentGuest = guest;

    document.getElementById('guest-msg').disabled = false;
    document.getElementById('send-guest-msg').disabled = false;

    renderGuestInfo();
}

// --- RENDER GUEST INFO ---
function renderGuestInfo(){
    if(!currentGuest) return;
    document.getElementById('welcome-text').innerText = `Welcome ${currentGuest.last_name}s!`;

    const today = new Date();
    today.setHours(0,0,0,0);
    const checkout = new Date(currentGuest.check_out_date);
    checkout.setHours(0,0,0,0);

    const timeDiff = checkout - today;
    const daysLeft = Math.max(Math.ceil(timeDiff / (1000*60*60*24)), 0);
    document.getElementById('days-left').innerText = `Days left: ${daysLeft}`;

    const checkin = new Date(currentGuest.check_in_date);
    checkin.setHours(0,0,0,0);

    const calendarDiv = document.getElementById('calendar');
    calendarDiv.innerHTML = '';
    for(let d = new Date(checkin); d <= checkout; d.setDate(d.getDate()+1)){
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day';
        const dateCopy = new Date(d);
        if(dateCopy < today) dayDiv.classList.add('past');
        else if(dateCopy.toDateString() === today.toDateString()) dayDiv.classList.add('current');
        else dayDiv.classList.add('future');
        dayDiv.innerText = d.getDate();
        calendarDiv.appendChild(dayDiv);
    }
}

// --- MESSAGES ---
async function loadMessages(){
    if(!currentGuest) return;
    const { data: msgs } = await supabaseClient.from('messages').select('*').order('created_at',{ ascending:true });
    const list = document.getElementById('message-list');
    list.innerHTML = '';
    if(!msgs) return;
    msgs.forEach(m=>{
        let sender;
        if(m.guest_id === currentGuest.id) sender = "You";
        else sender = m.guest_id === null ? "Admin" : "Other Guest";
        const div = document.createElement('div');
        div.className = "p-2 bg-gray-100 rounded-xl";
        div.innerHTML = `<strong>${sender}:</strong> ${m.message} <span class="text-xs text-gray-400 ml-2">(${new Date(m.created_at).toLocaleTimeString()})</span>`;
        list.appendChild(div);
    });
    list.scrollTop = list.scrollHeight;
}
setInterval(loadMessages, 3000);

// --- SEND MESSAGE ---
document.getElementById('send-guest-msg').onclick = async () => {
    if(guestLock || !currentGuest) return alert("Device is locked or no active guest");
    const msg = document.getElementById('guest-msg').value.trim();
    if(!msg) return;
    await supabaseClient.from('messages').insert({ guest_id: currentGuest.id, message: msg });
    document.getElementById('guest-msg').value = '';
    loadMessages();
};

// --- TABLET LOCK ---
async function checkLock(){
    const { data } = await supabaseClient.from('tablet_lock').select('*').eq('id',1).maybeSingle();
    guestLock = data?.is_locked || false;
    document.getElementById('locked-overlay').style.display = guestLock ? 'flex' : 'none';
}
setInterval(checkLock, 2000);

// --- INIT ---
guestLogin();
</script>

</body>
</html>
