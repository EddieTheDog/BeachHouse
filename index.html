<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beach House Guest Dashboard v2.9</title>
<style>
html,body{height:100%;margin:0;padding:0;font-family:Arial,sans-serif;background:linear-gradient(135deg,#0072ff,#00c6ff);color:#fff;}
.container{width:95%;max-width:600px;margin:auto;padding:20px;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;}
h1,h2{text-align:center;text-shadow:1px 1px 5px rgba(0,0,0,0.3);}
button,input,textarea{padding:10px;margin:5px;border-radius:10px;border:none;}
button{cursor:pointer;font-weight:bold;background:#005dbf;color:#fff;transition:.3s;width:100%;}
button:hover{background:#003f7f;}
#messages{width:100%;max-height:300px;overflow-y:auto;margin-top:10px;background:rgba(0,0,0,0.2);border-radius:10px;padding:10px;}
.message{background:rgba(255,255,255,0.2);margin:5px 0;padding:8px;border-radius:10px;word-wrap:break-word;}
.message.admin{background:rgba(0,0,0,0.3);}
#workRequests{margin-top:10px;width:100%;}
#dates{margin-top:10px;width:100%;text-align:center;font-weight:bold;}
#popupOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;}
#popup{background:#00c6ff;color:#000;padding:20px;border-radius:15px;width:80%;max-width:400px;display:flex;flex-direction:column;}
#popup input, #popup textarea{width:100%;margin-bottom:10px;}
</style>
</head>
<body>
<div class="container">
<h1>Welcome to the Beach House</h1>
<p id="welcomeMessage"></p>
<div id="dates"></div>
<div id="messages"></div>

<div id="workRequests">
<button id="submitRequestBtn">Submit Work Request</button>
</div>

<button id="checkoutBtn">I'm Leaving</button>
</div>

<!-- Popup for Work Request -->
<div id="popupOverlay">
<div id="popup">
<h3>Submit Work Request</h3>
<textarea id="requestText" placeholder="Describe your request..."></textarea>
<button id="sendRequestBtn">Send Request</button>
<button id="cancelPopupBtn">Cancel</button>
</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const SUPABASE_URL = 'https://ofnlpqfscyecatetnuqi.supabase.co';
const SUPABASE_KEY = 'sb_publishable_jjdmHkgGrbjqY14kS9ng_Ivuq-Pjc';
const supabase = createClient(SUPABASE_URL,SUPABASE_KEY);

let guest=null;
const messagesDiv = document.getElementById('messages');
const welcomeMessage = document.getElementById('welcomeMessage');
const datesDiv = document.getElementById('dates');

async function loadGuest(){
  const today = new Date().toISOString().slice(0,10);
  const { data } = await supabase.from('guests').select('*').lte('end_date',today).gte('start_date',today).eq('active',true).order('start_date',{ascending:true});
  if(data.length===0){
    welcomeMessage.innerText="No scheduled guests today.";
    return;
  }
  guest = data[0];
  const start = new Date(guest.start_date);
  const end = new Date(guest.end_date);
  const daysLeft = Math.ceil((end-new Date())/(1000*60*60*24))+1;
  welcomeMessage.innerText=`Welcome ${guest.guest_last_name}${daysLeft>1?'s':''}!`;
  datesDiv.innerText=`Stay: ${guest.start_date} â†’ ${guest.end_date} (${daysLeft} day${daysLeft>1?'s':''} left)`;
  loadMessages();
}
loadGuest();

async function loadMessages(){
  if(!guest) return;
  const { data } = await supabase.from('messages').select('*').eq('guest_id',guest.id).order('date',{ascending:true});
  messagesDiv.innerHTML='';
  data.forEach(m=>{
    const div=document.createElement('div');
    div.className='message admin';
    div.innerText=m.message_text;
    messagesDiv.appendChild(div);
  });
}

// Work Request popup
const popupOverlay=document.getElementById('popupOverlay');
document.getElementById('submitRequestBtn').onclick=()=>{if(!guest){alert("No guest today");return;} popupOverlay.style.display='flex';}
document.getElementById('cancelPopupBtn').onclick=()=>{popupOverlay.style.display='none';}
document.getElementById('sendRequestBtn').onclick=async()=>{
  const text=document.getElementById('requestText').value.trim();
  if(!text){alert("Enter a request"); return;}
  await supabase.from('work_requests').insert([{guest_id:guest.id,request_text:text,date:new Date().toISOString()}]);
  document.getElementById('requestText').value='';
  popupOverlay.style.display='none';
  alert("Work request sent!");
}

// Checkout
document.getElementById('checkoutBtn').onclick=async()=>{
  if(!guest) return;
  if(!confirm("Are you leaving? This will check you out.")) return;
  await supabase.from('guests').update({active:false}).eq('id',guest.id);
  await supabase.from('work_requests').delete().eq('guest_id',guest.id);
  await supabase.from('messages').delete().eq('guest_id',guest.id);
  alert("Checked out. Thank you!");
  location.reload();
}

// Auto cleanup at midnight
setInterval(async()=>{
  if(!guest) return;
  const today=new Date().toISOString().slice(0,10);
  if(today>guest.end_date){
    await supabase.from('guests').update({active:false}).eq('id',guest.id);
    await supabase.from('work_requests').delete().eq('guest_id',guest.id);
    await supabase.from('messages').delete().eq('guest_id',guest.id);
    alert("Your stay is over. Checked out automatically.");
    location.reload();
  }
},60000);

</script>
</body>
</html>
