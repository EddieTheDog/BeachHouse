<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beach House Guest Portal</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  .locked-overlay {position:fixed; inset:0; background:rgba(15,23,42,0.98); z-index:100; display:none; flex-direction:column; align-items:center; justify-content:center; color:white; backdrop-filter:blur(10px);}
  .calendar {display:flex; flex-wrap:wrap; gap:4px; margin-top:8px;}
  .day {width:32px; height:32px; display:flex; align-items:center; justify-content:center; font-size:12px; border-radius:50%;}
  .past {background:#e5e7eb;color:#9ca3af;}
  .today {background:#22c55e;color:white;font-weight:bold;}
  .future {background:#f3f4f6;color:#111827;}
</style>
</head>
<body class="bg-gray-50 font-sans relative">

<div class="locked-overlay" id="locked-overlay">
  <span class="text-6xl mb-4">ðŸ”’</span>
  <h2 class="text-2xl font-black uppercase tracking-widest">Device Locked</h2>
  <p class="text-gray-300 mt-2">Please see the host for assistance.</p>
</div>

<div class="max-w-3xl mx-auto p-4 md:p-8">
  <header class="flex justify-between items-center mb-8">
    <h1 class="text-2xl font-black text-gray-900">Beach House</h1>
    <p id="current-time" class="text-gray-700 font-mono font-bold"></p>
  </header>

  <main class="bg-white p-6 rounded-2xl shadow-sm">
    <h2 class="text-xl font-bold mb-2" id="guest-title">Loading...</h2>
    <p id="days-left" class="text-sm text-gray-500 mb-4"></p>
    <div id="calendar" class="calendar"></div>

    <section class="mt-6">
      <h3 class="font-bold mb-2">Concierge Chat</h3>
      <div class="flex gap-2 mb-2">
        <input type="text" id="guest-msg" class="border-2 border-gray-200 rounded-xl p-3 flex-1" placeholder="Send a message..." disabled>
        <button id="send-btn" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold" disabled>Send</button>
      </div>
      <div id="message-list" class="max-h-64 overflow-y-auto space-y-2"></div>
    </section>

    <div id="announcement-banner" class="hidden mt-6 p-4 bg-indigo-600 text-white rounded-2xl flex items-center gap-2 shadow-lg">
      <span class="text-2xl animate-bounce">ðŸ“¢</span>
      <p id="announcement-text" class="font-bold"></p>
    </div>
  </main>
</div>

<script>
const SUPABASE_URL = 'https://ofnlpqfscyecatetnuqi.supabase.co';
const SUPABASE_KEY = 'sb_publishable_jjdmHkgGrbjqYwY14kS9ng_Ivuq-Pjc';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentGuest = null;

// --- CLOCK ---
function updateTime() {
  const now = new Date();
  document.getElementById('current-time').innerText = now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
setInterval(updateTime, 1000);
updateTime();

// --- AUTO LOGIN ---
async function autoLogin() {
  let lastName = localStorage.getItem('guest_last_name');
  const todayISO = new Date().toISOString().split('T')[0];
  let guest = null;

  if (lastName) {
    const { data } = await supabase.from('families')
      .select('*')
      .eq('last_name', lastName)
      .gte('check_out_date', todayISO)
      .maybeSingle();
    guest = data;
  }

  if (!guest) {
    lastName = prompt("Enter your last name:");
    if(!lastName) return autoLogin();
    const confirmName = confirm(`Welcome ${lastName}s! Is this correct?`);
    if(!confirmName) return autoLogin();

    const { data } = await supabase.from('families')
      .select('*')
      .eq('last_name', lastName)
      .gte('check_out_date', todayISO)
      .maybeSingle();
    if (!data) return alert("No active stay found") && autoLogin();
    guest = data;
    localStorage.setItem('guest_last_name', lastName);
  }

  currentGuest = guest;
  document.getElementById('guest-msg').disabled = false;
  document.getElementById('send-btn').disabled = false;

  document.getElementById('guest-title').innerText = `Hello, ${guest.last_name}s!`;
  const ci = new Date(guest.check_in_date);
  const co = new Date(guest.check_out_date);
  const daysLeft = Math.max(Math.ceil((co - new Date())/(1000*60*60*24)),0);
  document.getElementById('days-left').innerText = `Days left: ${daysLeft}`;

  renderCalendar();
  loadMessages();
  checkAnnouncements();
  checkLockStatus();

  setInterval(loadMessages, 3000);
  setInterval(checkAnnouncements, 5000);
  setInterval(checkLockStatus, 2000);
}

// --- CALENDAR ---
function renderCalendar() {
  const cal = document.getElementById('calendar');
  cal.innerHTML = '';
  const start = new Date(currentGuest.check_in_date);
  const end = new Date(currentGuest.check_out_date);
  const today = new Date(); today.setHours(0,0,0,0);

  for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
    const div = document.createElement('div');
    div.className = 'day';
    const isToday = d.toDateString() === today.toDateString();
    div.classList.add(isToday?'today': (d<today?'past':'future'));
    div.innerText = d.getDate();
    cal.appendChild(div);
  }
}

// --- CHAT ---
async function loadMessages() {
  const { data } = await supabase.from('messages')
    .select('*')
    .eq('family_id', currentGuest.id)
    .order('created_at', {ascending:true});
  const list = document.getElementById('message-list');
  list.innerHTML = data?.map(m=>`
    <div class="p-2 rounded-xl text-sm ${m.sent_by==='guest'?'bg-blue-600 text-white self-end ml-10':'bg-gray-200 text-gray-700 self-start mr-10'}">
      ${m.message}
    </div>
  `).join('')||'';
  list.scrollTop = list.scrollHeight;
}

document.getElementById('send-btn').onclick = async ()=>{
  const input = document.getElementById('guest-msg');
  if(!input.value.trim()) return;
  await supabase.from('messages').insert({family_id:currentGuest.id,message:input.value,sent_by:'guest'});
  input.value='';
  loadMessages();
};

// --- ANNOUNCEMENTS ---
async function checkAnnouncements() {
  const { data } = await supabase.from('announcements').select('*').limit(1).maybeSingle();
  const banner = document.getElementById('announcement-banner');
  if(data && new Date(data.expires_at)>new Date()){
    document.getElementById('announcement-text').innerText = data.message;
    banner.classList.remove('hidden');
  } else banner.classList.add('hidden');
}

// --- TABLET LOCK ---
async function checkLockStatus() {
  const { data } = await supabase.from('tablet_lock').select('*').eq('id',1).maybeSingle();
  document.getElementById('locked-overlay').style.display = data?.is_locked?'flex':'none';
}

// --- INIT ---
autoLogin();
</script>

</body>
</html>
