<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beach House Guest Dashboard v2.7</title>
<style>
html,body{height:100%;margin:0;padding:0;font-family:Arial,sans-serif;background:linear-gradient(135deg,#0072ff,#00c6ff);color:#fff;display:flex;justify-content:center;align-items:center;}
.container{width:100%;max-width:600px;padding:20px;text-align:center;}
button,input,textarea{padding:10px;margin:5px;border-radius:10px;border:none;}
button{cursor:pointer;font-weight:bold;}
.modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:10;}
.modal{background:#fff;color:#000;padding:20px;border-radius:15px;width:90%;max-width:400px;display:flex;flex-direction:column;}
</style>
</head>
<body>
<div class="container">
<h1>Beach House Dashboard v2.7</h1>
<div id="welcome"></div>

<div id="mainContent" style="display:none;">
<h3>Work Requests</h3>
<textarea id="workRequestText" placeholder="Describe your request"></textarea><br>
<button id="submitWorkRequest">Submit Work Request</button>
<ul id="workRequestsList"></ul>

<h3>Messages</h3>
<textarea id="guestMessageText" placeholder="Message host"></textarea><br>
<button id="submitGuestMessage">Send Message</button>
<ul id="messagesList"></ul>

<div id="checkoutDiv" style="margin-top:20px;">
<button id="checkoutBtn" style="display:none;">Iâ€™m Leaving</button>
</div>

<p id="status"></p>
</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://ofnlpqfscyecatetnuqi.supabase.co';
const SUPABASE_KEY = 'sb_publishable_jjdmHkgGrbjqYwY14kS9ng_Ivuq-Pjc';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

let guest = null;

// Initialize guest session
async function initGuest(){
  const today = new Date().toISOString().slice(0,10);
  const { data, error } = await supabase.from('guests').select('*').eq('active',true).lte('start_date',today).gte('end_date',today);
  if(error){console.error(error);return;}
  if(data.length===0){document.getElementById('welcome').innerText="No scheduled guests today";return;}
  guest = data[0];

  if(!guest.verification_date){
    showWelcomeModal();
  } else {
    document.getElementById('mainContent').style.display='block';
    loadWorkRequests();
    loadMessages();
    checkCheckoutButton();
  }
}
initGuest();

// Welcome modal
function showWelcomeModal(){
  const modalBg = document.createElement('div'); modalBg.className='modal-bg';
  const modal = document.createElement('div'); modal.className='modal';
  modal.innerHTML = `<h2>Welcome ${guest.guest_last_name}${guest.guest_last_name.endsWith('s')?'':'s'}</h2>
  <p>Is this you?</p>
  <button id="yesBtn">Yes</button>
  <button id="noBtn">No</button>`;
  modalBg.appendChild(modal); document.body.appendChild(modalBg);
  modalBg.style.display='flex';
  document.getElementById('yesBtn').onclick = async ()=>{
    await supabase.from('guests').update({verification_status:'verified',verification_date:new Date().toISOString()}).eq('id',guest.id);
    document.body.removeChild(modalBg);
    document.getElementById('mainContent').style.display='block';
    loadWorkRequests(); loadMessages(); checkCheckoutButton();
  }
  document.getElementById('noBtn').onclick = ()=>{
    alert("Please contact host to unlock"); modalBg.style.display='none';
  }
}

// Work requests
const submitWorkRequest = document.getElementById('submitWorkRequest');
const workRequestText = document.getElementById('workRequestText');
const workRequestsList = document.getElementById('workRequestsList');

submitWorkRequest.onclick = async ()=>{
  if(!workRequestText.value.trim()){return;}
  await supabase.from('work_requests').insert([{guest_id:guest.id,request_text:workRequestText.value.trim(),date:new Date().toISOString()}]);
  workRequestText.value='';
  loadWorkRequests();
}

async function loadWorkRequests(){
  const { data } = await supabase.from('work_requests').select('*').eq('guest_id',guest.id).order('date',{ascending:true});
  workRequestsList.innerHTML='';
  data.forEach(r=>{const li=document.createElement('li'); li.textContent=`${r.request_text} (${new Date(r.date).toLocaleString()})`; workRequestsList.appendChild(li);});
}

// Messages
const submitGuestMessage = document.getElementById('submitGuestMessage');
const guestMessageText = document.getElementById('guestMessageText');
const messagesList = document.getElementById('messagesList');

submitGuestMessage.onclick = async ()=>{
  if(!guestMessageText.value.trim()) return;
  await supabase.from('messages').insert([{guest_id:guest.id,message_text:guestMessageText.value.trim(),date:new Date().toISOString()}]);
  guestMessageText.value='';
  loadMessages();
}

async function loadMessages(){
  const { data } = await supabase.from('messages').select('*').eq('guest_id',guest.id).order('date',{ascending:true});
  messagesList.innerHTML='';
  data.forEach(m=>{const li=document.createElement('li'); li.textContent=`${m.message_text} (${new Date(m.date).toLocaleString()})`; messagesList.appendChild(li);});
}

// Checkout
function checkCheckoutButton(){
  const today = new Date().toISOString().slice(0,10);
  if(today===guest.end_date){
    document.getElementById('checkoutBtn').style.display='inline-block';
  }
}

document.getElementById('checkoutBtn').onclick = async ()=>{
  await checkoutGuest();
}

async function checkoutGuest(){
  await supabase.from('guests').update({active:false}).eq('id',guest.id);
  await supabase.from('work_requests').delete().eq('guest_id',guest.id);
  await supabase.from('messages').delete().eq('guest_id',guest.id);
  alert("You are checked out. Goodbye!");
  location.reload();
}

// Automatic checkout at midnight
setInterval(async ()=>{
  const now = new Date();
  if(now.getHours()===0 && now.getMinutes()===0){
    if(guest){
      const today = now.toISOString().slice(0,10);
      if(today > guest.end_date){
        await checkoutGuest();
      }
    }
  }
},60000);
</script>
</body>
</html>
