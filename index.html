<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Beach House Guest Dashboard v2.1</title>
<style>
body { margin:0; font-family:Arial; background:#e0f7ff; display:flex; flex-direction:column; min-height:100vh;}
header { background:#00aaff; color:white; padding:15px; text-align:center; font-size:24px;}
main { flex:1; max-width:600px; margin:auto; padding:20px; display:flex; flex-direction:column; gap:15px;}
button { background:#00aaff; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer;}
input, textarea { width:100%; padding:8px; border-radius:5px; border:1px solid #ccc;}
.message-app { border:1px solid #00aaff; border-radius:6px; padding:10px; max-height:200px; overflow-y:auto; background:white;}
.hidden { display:none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
</head>
<body>
<header>Beach House Guest Dashboard</header>
<main>
<div id="welcome"></div>

<div id="checkin-section" class="hidden">
    <p>Welcome to the Beach House! Is this you?</p>
    <button id="yes-btn">Yes</button>
    <button id="no-btn">No</button>
</div>

<div id="guest-actions" class="hidden">
    <p>Days left: <span id="days-left"></span></p>
    <button id="checkout-btn">I'm Leaving</button>
    <button id="work-request-btn">Submit Work Request</button>
    <div id="work-request-form" class="hidden">
        <textarea id="request-text" placeholder="Describe your work request"></textarea>
        <button id="submit-request-btn">Submit</button>
    </div>

    <div class="message-app" id="messages"></div>
    <textarea id="new-message" placeholder="Send a message to host"></textarea>
    <button id="send-message-btn">Send</button>
</div>

<script>
window.addEventListener('DOMContentLoaded', async () => {
    // Initialize Supabase
    const supabaseClient = supabase.createClient(
        'https://ofnlpqfscyecatetnuqi.supabase.co',
        'sb_publishable_jjdmHkgGrbjqYwY14kS9ng_Ivuq-Pjc'
    );

    let guestData = null;

    async function loadGuest() {
        const today = new Date().toISOString().split('T')[0];

        // Fetch guests active today
        const { data, error } = await supabaseClient
            .from('guests')
            .select('*')
            .gte('start_date', today)
            .lte('end_date', today)
            .eq('active', true)
            .order('start_date', { ascending:true });

        const welcomeDiv = document.getElementById('welcome');
        const checkinSection = document.getElementById('checkin-section');
        const guestActions = document.getElementById('guest-actions');

        // Hide all sections first
        checkinSection.classList.add('hidden');
        guestActions.classList.add('hidden');

        if(error) { welcomeDiv.innerText = "Error loading guest info."; console.error(error); return; }
        if(!data || data.length === 0) {
            welcomeDiv.innerText = "No guests scheduled today.";
            return;
        }

        guestData = data[0];

        if(guestData.verification_status === 'pending'){
            checkinSection.classList.remove('hidden');
        } else if(guestData.verification_status === 'verified'){
            guestActions.classList.remove('hidden');
            loadGuestDetails();
        } else if(guestData.verification_status === 'locked'){
            checkinSection.innerHTML = "<p>Tablet locked, contact host.</p>";
        }
    }

    function loadGuestDetails() {
        const today = new Date();
        const end = new Date(guestData.end_date);
        const diff = Math.ceil((end - today)/(1000*60*60*24)) + 1;
        document.getElementById('days-left').innerText = diff >= 0 ? diff : 0;
        loadMessages();
    }

    async function loadMessages() {
        if(!guestData) return;
        const { data, error } = await supabaseClient
            .from('messages')
            .select('*')
            .eq('guest_id', guestData.id)
            .order('created_at', { ascending:true });

        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = "";
        if(!data) return;
        data.forEach(m => {
            const p = document.createElement('p');
            p.innerText = m.message_text;
            messagesDiv.appendChild(p);
        });
    }

    document.getElementById('yes-btn').onclick = async () => {
        if(!guestData) return;
        await supabaseClient
            .from('guests')
            .update({ verification_status:'verified', checked_in:true })
            .eq('id', guestData.id);
        document.getElementById('checkin-section').classList.add('hidden');
        document.getElementById('guest-actions').classList.remove('hidden');
        loadGuestDetails();
    };

    document.getElementById('no-btn').onclick = async () => {
        if(!guestData) return;
        await supabaseClient
            .from('guests')
            .update({ verification_status:'locked' })
            .eq('id', guestData.id);
        document.getElementById('checkin-section').innerHTML = "<p>Tablet locked, contact host.</p>";
    };

    document.getElementById('checkout-btn').onclick = async () => {
        if(!guestData) return;
        await supabaseClient
            .from('guests')
            .update({ active:false })
            .eq('id', guestData.id);
        alert("You have checked out!");
        location.reload();
    };

    document.getElementById('work-request-btn').onclick = () => {
        document.getElementById('work-request-form').classList.remove('hidden');
    };

    document.getElementById('submit-request-btn').onclick = async () => {
        if(!guestData) return;
        const text = document.getElementById('request-text').value.trim();
        if(!text) return;
        await supabaseClient
            .from('work_requests')
            .insert({ guest_id: guestData.id, request_text: text });
        document.getElementById('request-text').value = "";
        document.getElementById('work-request-form').classList.add('hidden');
        alert("Work request submitted!");
    };

    document.getElementById('send-message-btn').onclick = async () => {
        if(!guestData) return;
        const text = document.getElementById('new-message').value.trim();
        if(!text) return;
        await supabaseClient
            .from('messages')
            .insert({ guest_id: guestData.id, message_text: text });
        document.getElementById('new-message').value = "";
        loadMessages();
    };

    loadGuest();
});
</script>
</main>
</body>
</html>
