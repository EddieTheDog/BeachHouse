<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beach House Guest Dashboard v2.1</title>
<style>
body { font-family: Arial,sans-serif; margin:0; padding:0; background:linear-gradient(135deg,#00c6ff,#0072ff); color:#fff;}
.container { max-width:900px; margin:0 auto; padding:20px;}
h1,h2 { text-align:center; margin-bottom:20px;}
.calendar { display:flex; flex-wrap:wrap; justify-content:center; margin:20px 0;}
.day { width:70px; height:60px; margin:5px; display:flex; justify-content:center; align-items:center; border-radius:10px; background-color:rgba(255,255,255,0.2); font-weight:bold;}
.today { border:3px solid #fff;}
.checked-in { background-color:#00ff6a; color:#000;}
textarea,button { width:100%; padding:10px; margin:5px 0; border-radius:10px; border:none; font-size:1rem;}
button { cursor:pointer; font-weight:bold; transition:0.2s;}
.submit-btn { background-color:#fff;color:#0072ff; font-weight:bold;}
.submit-btn:hover { opacity:0.8;}
.feedback { font-weight:bold; margin-top:5px;}
.hidden { display:none; }
</style>
</head>
<body>
<div class="container">
<h1>Beach House Guest Dashboard v2.1</h1>

<h2 id="welcomeMessage"></h2>
<div class="calendar" id="calendar"></div>

<div class="work-request hidden" id="workRequestSection">
  <textarea id="requestText" placeholder="Describe an issue..." rows="3"></textarea>
  <button class="submit-btn" id="submitRequestBtn">Submit Request</button>
  <span class="feedback" id="guestFeedback"></span>
</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://ofnlpqfscyecatetnuqi.supabase.co';
const SUPABASE_KEY = 'sb_publishable_jjdmHkgGrbjqYwY14kS9ng_Ivuq-Pjc';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const welcomeMessage = document.getElementById('welcomeMessage');
const calendarEl = document.getElementById('calendar');
const requestText = document.getElementById('requestText');
const submitRequestBtn = document.getElementById('submitRequestBtn');
const guestFeedback = document.getElementById('guestFeedback');
const workRequestSection = document.getElementById('workRequestSection');

let currentGuest = null;
const today = new Date().toISOString().slice(0,10);

async function loadGuest(){
  // Get guest scheduled today (start_date <= today <= end_date)
  const { data, error } = await supabase.from('guests')
    .select('*')
    .lte('start_date', today)
    .gte('end_date', today)
    .eq('active', true)
    .order('start_date', { ascending:true });

  if(error || !data || data.length === 0){
    welcomeMessage.textContent='No guest scheduled today.';
    workRequestSection.classList.add('hidden');
    calendarEl.innerHTML='';
    return;
  }

  currentGuest = data[0]; // pick first guest for this tablet
  welcomeMessage.textContent=`Welcome, ${currentGuest.guest_last_name}s!`;
  workRequestSection.classList.remove('hidden');

  if(!currentGuest.checked_in_dates.includes(today)){
    await markCheckedIn();
  }

  renderCalendar();
  scheduleMidnightSignOut();
}

async function markCheckedIn(){
  let updatedDates = currentGuest.checked_in_dates || [];
  if(!updatedDates.includes(today)) updatedDates.push(today);

  const { error } = await supabase.from('guests').update({checked_in_dates:updatedDates}).eq('id',currentGuest.id);
  if(error) console.error('Error checking in:', error);
  currentGuest.checked_in_dates = updatedDates;
}

function renderCalendar(){
  calendarEl.innerHTML='';
  const start = new Date(currentGuest.start_date);
  const end = new Date(currentGuest.end_date);

  for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
    const dayStr = d.toISOString().slice(0,10);
    const div = document.createElement('div');
    div.className='day';
    if(dayStr===today) div.classList.add('today');
    if(currentGuest.checked_in_dates.includes(dayStr)) div.classList.add('checked-in');
    div.textContent = d.toLocaleDateString('en-US');
    calendarEl.appendChild(div);
  }
}

submitRequestBtn.addEventListener('click', async ()=>{
  if(!currentGuest){ guestFeedback.textContent='You must be checked in first.'; return; }
  const text = requestText.value.trim();
  if(!text){ guestFeedback.textContent='Enter a request.'; return; }

  const { error } = await supabase.from('work_requests').insert([{guest_id:currentGuest.id,request_text:text}]);
  if(error){ guestFeedback.textContent='Error submitting request.'; console.error(error);}
  else { guestFeedback.textContent='Request submitted!'; requestText.value=''; }
});

function scheduleMidnightSignOut(){
  const now=new Date();
  const msUntilMidnight=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1)-now;
  setTimeout(()=>{ guestFeedback.textContent='You have been signed out for the day.'; scheduleMidnightSignOut(); }, msUntilMidnight);
}

loadGuest();
</script>
</body>
</html>
